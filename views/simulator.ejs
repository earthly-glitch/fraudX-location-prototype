<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
      background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
      color: #e0e0e0;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      margin-bottom: 40px;
      border-bottom: 1px solid rgba(52, 211, 153, 0.2);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: #34d399;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 20px;
      color: #0f2027;
    }

    .logo-text {
      font-size: 24px;
      font-weight: 700;
      color: #fff;
    }

    .nav-links {
      display: flex;
      gap: 30px;
    }

    .nav-links a {
      color: #94a3b8;
      text-decoration: none;
      font-size: 16px;
      transition: color 0.3s;
    }

    .nav-links a:hover,
    .nav-links a.active {
      color: #34d399;
    }

    /* Main Content */
    .main-title {
      font-size: 48px;
      font-weight: 700;
      margin-bottom: 16px;
      background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      font-size: 18px;
      color: #94a3b8;
      margin-bottom: 40px;
      max-width: 600px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      background: rgba(52, 211, 153, 0.1);
      border: 1px solid rgba(52, 211, 153, 0.3);
      border-radius: 20px;
      font-size: 13px;
      color: #34d399;
      margin-bottom: 20px;
    }

    /* Control Panel */
    .control-panel {
      background: rgba(15, 32, 39, 0.6);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(52, 211, 153, 0.2);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
    }

    .panel-header {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 25px;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    label {
      font-size: 14px;
      font-weight: 500;
      color: #94a3b8;
    }

    input, select {
      padding: 12px 16px;
      background: rgba(15, 32, 39, 0.8);
      border: 1px solid rgba(52, 211, 153, 0.3);
      border-radius: 8px;
      color: #e0e0e0;
      font-size: 15px;
      transition: all 0.3s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #34d399;
      box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.1);
    }

    .button-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: #34d399;
      color: #0f2027;
    }

    .btn-primary:hover {
      background: #10b981;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(52, 211, 153, 0.3);
    }

    .btn-danger {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.4);
    }

    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.3);
    }

    .btn-secondary {
      background: rgba(148, 163, 184, 0.2);
      color: #94a3b8;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .btn-secondary:hover {
      background: rgba(148, 163, 184, 0.3);
    }

    /* Active Simulations */
    .simulations-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
    }

    .sim-card {
      background: rgba(15, 32, 39, 0.6);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(52, 211, 153, 0.2);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s;
    }

    .sim-card:hover {
      border-color: rgba(52, 211, 153, 0.5);
      transform: translateY(-4px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
    }

    .sim-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .device-id {
      font-size: 18px;
      font-weight: 600;
      color: #fff;
    }

    .mode-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .mode-normal {
      background: rgba(52, 211, 153, 0.2);
      color: #34d399;
    }

    .mode-fast {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
    }

    .mode-teleport {
      background: rgba(139, 92, 246, 0.2);
      color: #8b5cf6;
    }

    .sim-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 15px;
    }

    .stat {
      background: rgba(15, 32, 39, 0.8);
      padding: 10px;
      border-radius: 8px;
    }

    .stat-label {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 16px;
      font-weight: 600;
      color: #fff;
    }

    .progress-bar {
      height: 6px;
      background: rgba(15, 32, 39, 0.8);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #34d399, #10b981);
      transition: width 0.3s;
    }

    /* Console */
    .console {
      background: rgba(15, 32, 39, 0.8);
      border: 1px solid rgba(52, 211, 153, 0.2);
      border-radius: 12px;
      padding: 20px;
      margin-top: 30px;
      max-height: 400px;
      overflow-y: auto;
    }

    .console-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .console-title {
      font-size: 16px;
      font-weight: 600;
      color: #94a3b8;
    }

    .console-log {
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
    }

    .log-entry {
      padding: 6px 0;
      border-bottom: 1px solid rgba(52, 211, 153, 0.1);
    }

    .log-time {
      color: #64748b;
      margin-right: 10px;
    }

    .log-success {
      color: #34d399;
    }

    .log-error {
      color: #ef4444;
    }

    .log-info {
      color: #60a5fa;
    }

    .log-warning {
      color: #fbbf24;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(15, 32, 39, 0.5);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(52, 211, 153, 0.3);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(52, 211, 153, 0.5);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <div class="logo-icon">FX</div>
        <span class="logo-text">FraudX</span>
      </div>
      <nav class="nav-links">
        <a href="/dashboard">Dashboard</a>
        <a href="/simulator" class="active">Simulator</a>
      </nav>
    </header>

    <!-- Main Content -->
    <div class="badge">‚ö° Simulation Control Panel</div>
    <h1 class="main-title">Ping Simulator</h1>
    <p class="subtitle">Test fraud detection with automated location pings across different movement patterns.</p>

    <!-- Control Panel -->
    <div class="control-panel">
      <h2 class="panel-header">üéÆ Start New Simulation</h2>
      
      <form id="simulatorForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="deviceId">Device ID</label>
            <input type="text" id="deviceId" placeholder="e.g., device_001" required>
          </div>
          
          <div class="form-group">
            <label for="mode">Movement Mode</label>
            <select id="mode">
              <option value="normal">Normal (Walking/Driving)</option>
              <option value="fast">Fast (Highway Speed)</option>
              <option value="teleport">Teleport (Instant Jump)</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="interval">Ping Interval (seconds)</label>
            <input type="number" id="interval" min="5" max="60" value="10">
          </div>
        </div>

        <div class="button-group">
          <button type="submit" class="btn-primary">
            <span>‚ñ∂</span> Start Simulation
          </button>
          <button type="button" onclick="stopAllSimulations()" class="btn-danger">
            <span>‚èπ</span> Stop All
          </button>
          <button type="button" onclick="refreshStatus()" class="btn-secondary">
            <span>üîÑ</span> Refresh
          </button>
        </div>
      </form>
    </div>

    <!-- Active Simulations -->
    <h2 class="panel-header" style="margin-bottom: 20px;">üì° Active Simulations</h2>
    <div id="simulationsContainer" class="simulations-grid"></div>

    <!-- Console -->
    <div class="console">
      <div class="console-header">
        <span class="console-title">üìä Event Log</span>
        <button onclick="clearConsole()" class="btn-secondary" style="padding: 6px 12px; font-size: 13px;">Clear</button>
      </div>
      <div id="consoleLog" class="console-log"></div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const apiUrl = '<%= apiUrl %>';

    // Form submission
    document.getElementById('simulatorForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const deviceId = document.getElementById('deviceId').value;
      const mode = document.getElementById('mode').value;
      const interval = document.getElementById('interval').value;

      try {
        const response = await fetch(`${apiUrl}/api/simulator/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ deviceId, mode, interval: parseInt(interval) })
        });

        const data = await response.json();
        
        if (data.ok) {
          logToConsole('success', `Started simulation for ${deviceId}`);
          document.getElementById('deviceId').value = '';
          refreshStatus();
        } else {
          logToConsole('error', data.error || 'Failed to start simulation');
        }
      } catch (error) {
        logToConsole('error', `Error: ${error.message}`);
      }
    });

    // Refresh status
    async function refreshStatus() {
      try {
        const response = await fetch(`${apiUrl}/api/simulator/status`);
        const data = await response.json();
        
        if (data.ok) {
          renderSimulations(data.activeSimulations);
        }
      } catch (error) {
        logToConsole('error', `Error fetching status: ${error.message}`);
      }
    }

    // Stop all simulations
    async function stopAllSimulations() {
      try {
        const response = await fetch(`${apiUrl}/api/simulator/stop-all`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();
        
        if (data.ok) {
          logToConsole('info', data.message);
          refreshStatus();
        }
      } catch (error) {
        logToConsole('error', `Error: ${error.message}`);
      }
    }

    // Stop individual simulation
    async function stopSimulation(deviceId) {
      try {
        const response = await fetch(`${apiUrl}/api/simulator/stop`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ deviceId })
        });

        const data = await response.json();
        
        if (data.ok) {
          logToConsole('info', `Stopped simulation for ${deviceId}`);
          refreshStatus();
        }
      } catch (error) {
        logToConsole('error', `Error: ${error.message}`);
      }
    }

    // Render simulations
    function renderSimulations(simulations) {
      const container = document.getElementById('simulationsContainer');
      
      if (!simulations || simulations.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üéØ</div>
            <p>No active simulations</p>
          </div>
        `;
        return;
      }

      container.innerHTML = simulations.map(sim => {
        const progress = (sim.progress.split('/').map(Number));
        const progressPercent = (progress[0] / progress[1]) * 100;

        return `
          <div class="sim-card">
            <div class="sim-header">
              <span class="device-id">${sim.deviceId}</span>
              <span class="mode-badge mode-${sim.mode}">${sim.mode}</span>
            </div>

            <div class="sim-stats">
              <div class="stat">
                <div class="stat-label">Pings Sent</div>
                <div class="stat-value">${sim.pingCount}</div>
              </div>
              <div class="stat">
                <div class="stat-label">Frauds Found</div>
                <div class="stat-value">${sim.stats?.fraudsDetected || 0}</div>
              </div>
              <div class="stat">
                <div class="stat-label">Max Speed</div>
                <div class="stat-value">${sim.stats?.maxSpeed?.toFixed(1) || 0} km/h</div>
              </div>
              <div class="stat">
                <div class="stat-label">Progress</div>
                <div class="stat-value">${sim.progress}</div>
              </div>
            </div>

            <div class="progress-bar">
              <div class="progress-fill" style="width: ${progressPercent}%"></div>
            </div>

            <div class="button-group">
              <button onclick="stopSimulation('${sim.deviceId}')" class="btn-danger" style="width: 100%;">
                <span>‚èπ</span> Stop
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Console logging
    function logToConsole(type, message) {
      const consoleLog = document.getElementById('consoleLog');
      const time = new Date().toLocaleTimeString();
      const typeClass = `log-${type}`;
      
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `<span class="log-time">[${time}]</span><span class="${typeClass}">${message}</span>`;
      
      consoleLog.appendChild(entry);
      consoleLog.scrollTop = consoleLog.scrollHeight;
    }

    function clearConsole() {
      document.getElementById('consoleLog').innerHTML = '';
    }

    // Socket.IO event listeners
    socket.on('simulation-started', (data) => {
      logToConsole('success', `üöÄ Simulation started: ${data.deviceId} (${data.mode} mode)`);
      refreshStatus();
    });

    socket.on('ping-sent', (data) => {
      logToConsole('info', `üìç Ping #${data.pingNumber} from ${data.deviceId} at ${data.location.name}`);
      
      if (data.result.fraudTypes) {
        logToConsole('warning', `‚ö†Ô∏è Fraud detected: ${data.result.fraudTypes.join(', ')} (Risk: ${data.result.riskScore})`);
      }
      
      refreshStatus();
    });

    socket.on('simulation-stopped', (data) => {
      logToConsole('info', `‚èπÔ∏è Simulation stopped: ${data.deviceId} (${data.totalPings} total pings)`);
      refreshStatus();
    });

    socket.on('route-completed', (data) => {
      logToConsole('success', `‚úÖ Route completed: ${data.deviceId}`);
    });

    socket.on('ping-error', (data) => {
      logToConsole('error', `‚ùå Error for ${data.deviceId}: ${data.error}`);
    });

    // Initial load
    refreshStatus();
    logToConsole('info', 'üéÆ Simulator control panel initialized');
  </script>
</body>
</html>
